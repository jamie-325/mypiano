<!DOCTYPE html>
<html>
<head>
  <title>Quest Hand Tracking Piano</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.2.0/dist/aframe-extras.min.js"></script>
  <script src="https://surikov.github.io/webaudiofont/npm/dist/WebAudioFontPlayer.js"></script>
  <script src="https://surikov.github.io/webaudiofontdata/sound/0000_Aspirin_sf2_file.js"></script>
</head>

<body>
  <a-scene 
    webxr="requiredFeatures: hand-tracking, local-floor; referenceSpaceType: local-floor"
    vr-mode-ui="enabled: true">

    <a-entity id="rig" movement-controls="fly: false; speed: 0.1">
      <a-camera position="0 1.6 0" look-controls="pointerLockEnabled: true"></a-camera>
      
      <a-entity oculus-touch-controls="hand: left"></a-entity>
      <a-entity oculus-touch-controls="hand: right"></a-entity>

      <a-entity id="leftHand" hand-tracking-controls="hand: left"></a-entity>
      <a-entity id="rightHand" hand-tracking-controls="hand: right"></a-entity>
    </a-entity>

    <a-entity id="piano" position="0 0.8 -0.5"></a-entity>

    <a-sphere id="leftTip" radius="0.01" color="red" visible="true"></a-sphere>
    <a-sphere id="rightTip" radius="0.01" color="blue" visible="true"></a-sphere>

  </a-scene>

  <script>
    // --- AUDIO SETUP ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const player = new WebAudioFontPlayer();
    const pianoInstrument = _tone_0000_Aspirin_sf2_file;
    player.loader.decodeAfterLoading(audioCtx, '_tone_0000_Aspirin_sf2_file');

    function playNote(midi) {
      if (audioCtx.state === 'suspended') audioCtx.resume();
      player.queueWaveTable(audioCtx, audioCtx.destination, pianoInstrument, audioCtx.currentTime, midi, 1.0);
    }

    // --- JOINT TRACKING ---
    function updateFingertips() {
      const hands = {'#leftHand': '#leftTip', '#rightHand': '#rightTip'};

      for (let handId in hands) {
        const handEl = document.querySelector(handId);
        const tipEl = document.querySelector(hands[handId]);
        
        if (handEl.components['hand-tracking-controls']) {
          const joints = handEl.components['hand-tracking-controls'].joints;
          if (joints && joints['index-finger-tip']) {
            // Match the red/blue spheres to your real index finger tips
            tipEl.object3D.position.copy(joints['index-finger-tip'].position);
          }
        }
      }
      requestAnimationFrame(updateFingertips);
    }

    // --- INTERACTIVE KEY COMPONENT ---
    AFRAME.registerComponent('ar-piano-key', {
      schema: { midi: { default: 60 }, color: { default: 'white' } },
      init: function () {
        this.originalColor = this.data.color;
        this.playing = false;
        this.worldPos = new THREE.Vector3();
      },
      tick: function () {
        const leftTip = document.querySelector('#leftTip').object3D.position;
        const rightTip = document.querySelector('#rightTip').object3D.position;
        
        // Check collision in world space so movement doesn't break detection
        this.el.object3D.getWorldPosition(this.worldPos);

        const distL = this.worldPos.distanceTo(leftTip);
        const distR = this.worldPos.distanceTo(rightTip);

        const isTouching = distL < 0.04 || distR < 0.04;

        if (isTouching && !this.playing) {
          this.playing = true;
          this.el.setAttribute('color', '#00FF00');
          this.el.object3D.position.y -= 0.01; // Key press animation
          playNote(this.data.midi);
        } else if (!isTouching && this.playing) {
          this.playing = false;
          this.el.setAttribute('color', this.originalColor);
          this.el.object3D.position.y += 0.01; // Key release
        }
      }
    });

    // --- GENERATE PIANO ---
    function createPiano() {
      const piano = document.querySelector('#piano');
      const whiteKeyWidth = 0.025;
      const keysCount = 24; 
      let midi = 60; // Starting at Middle C

      for (let i = 0; i < keysCount; i++) {
        let key = document.createElement('a-box');
        key.setAttribute('width', 0.02);
        key.setAttribute('height', 0.02);
        key.setAttribute('depth', 0.15);
        key.setAttribute('position', `${(i - keysCount/2) * whiteKeyWidth} 0 0`);
        key.setAttribute('color', 'white');
        key.setAttribute('ar-piano-key', `midi: ${midi}`);
        piano.appendChild(key);
        
        const note = midi % 12;
        midi += ([4, 11].includes(note)) ? 1 : 2;
      }
    }

    window.onload = () => {
      createPiano();
      updateFingertips();
    };
  </script>
</body>
</html>
