<!DOCTYPE html>
<html>
<head>
  <title>Real Piano 88 Keys - VR Movement</title>

  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  
  <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.2.0/dist/aframe-extras.min.js"></script>

  <script src="https://surikov.github.io/webaudiofont/npm/dist/WebAudioFontPlayer.js"></script>
  <script src="https://surikov.github.io/webaudiofontdata/sound/0000_Aspirin_sf2_file.js"></script>
</head>

<body>
  <a-scene webxr="requiredFeatures: local-floor">

    <a-entity id="rig" movement-controls="fly: false; speed: 0.15" position="0 0 1">
      <a-camera position="0 1.6 0" look-controls>
        <a-cursor raycaster="objects: [piano-key]"></a-cursor>
      </a-camera>

      <a-entity oculus-touch-controls="hand: left"></a-entity>
      <a-entity oculus-touch-controls="hand: right" raycaster="objects: [piano-key]; showLine: true"></a-entity>
    </a-entity>

    <a-entity id="piano" position="-2.5 0.8 -0.5"></a-entity>

    <a-grid></a-grid>

  </a-scene>

  <script>
    // ----------- REAL PIANO AUDIO SETUP -----------
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const player = new WebAudioFontPlayer();
    const pianoInstrument = _tone_0000_Aspirin_sf2_file;
    player.loader.decodeAfterLoading(audioCtx, '_tone_0000_Aspirin_sf2_file');

    function playRealPiano(midiNote) {
      // Resume audio context in case browser blocked it
      if (audioCtx.state === 'suspended') audioCtx.resume();
      
      player.queueWaveTable(audioCtx, audioCtx.destination, pianoInstrument, audioCtx.currentTime, midiNote, 1.5);
    }

   // ----------- PIANO KEY COMPONENT -----------
   AFRAME.registerComponent('piano-key', {
      schema: {
        color: { default: 'white' },
        midi: { default: 60 }
      },
      init: function () {
        const el = this.el;
        const originalColor = this.data.color;
        const midiNote = this.data.midi;

        // Use 'mousedown' for faster response on Quest controllers
        el.addEventListener('mousedown', () => {
          el.setAttribute('color', 'yellow');
          playRealPiano(midiNote);
          setTimeout(() => {
            el.setAttribute('color', originalColor);
          }, 150);
        });
      }
    });

    // ----------- BUILD FULL 88-KEY PIANO -----------
    function createPiano() {
      const piano = document.querySelector('#piano');
      const whiteKeyWidth = 0.1;
      
      // Starting at MIDI 21 (A0) which is the first key on a standard 88-key piano
      let midiPointer = 21; 
      
      // We will keep track of which MIDI notes are white vs black
      const whiteNotes = [0, 2, 4, 5, 7, 9, 11]; // C, D, E, F, G, A, B positions

      // 1. CREATE ALL 52 WHITE KEYS
      for (let i = 0; i < 52; i++) {
        let key = document.createElement('a-box');
        key.setAttribute('width', 0.095);
        key.setAttribute('height', 0.05);
        key.setAttribute('depth', 0.4);
        key.setAttribute('position', `${i * whiteKeyWidth} 0 0`);
        key.setAttribute('color', 'white');
        
        // Find the next available white note MIDI number
        while (!whiteNotes.includes(midiPointer % 12)) {
          midiPointer++;
        }
        
        key.setAttribute('piano-key', `color: white; midi: ${midiPointer}`);
        key.setAttribute('class', 'clickable');
        piano.appendChild(key);
        
        // 2. CREATE BLACK KEY (if one exists after this white key)
        // Black keys do not exist after E (index 4) and B (index 11)
        let noteInOctave = midiPointer % 12;
        if (noteInOctave !== 4 && noteInOctave !== 11 && i < 51) {
          let blackKey = document.createElement('a-box');
          blackKey.setAttribute('width', 0.06);
          blackKey.setAttribute('height', 0.08);
          blackKey.setAttribute('depth', 0.25);
          // Position it between this white key and the next one
          blackKey.setAttribute('position', `${(i * whiteKeyWidth) + (whiteKeyWidth / 2)} 0.03 -0.1`);
          blackKey.setAttribute('color', 'black');
          blackKey.setAttribute('piano-key', `color: black; midi: ${midiPointer + 1}`);
          blackKey.setAttribute('class', 'clickable');
          piano.appendChild(blackKey);
        }

        midiPointer++; // Move to next note for the next iteration
      }
    }

    window.onload = createPiano;
  </script>
</body>
</html>
