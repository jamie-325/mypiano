<!DOCTYPE html>
<html>
<head>
  <title>VR Piano Calibration</title>

  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
</head>

<body>

<script>

// -------- CALIBRATION SYSTEM --------

AFRAME.registerComponent('vr-calibrator', {
  init: function () {

    const piano = document.querySelector("#pianoRoot");

    let data = JSON.parse(localStorage.getItem("pianoCalibration"));

    if (data) {
      piano.setAttribute("position", data.position);
      piano.setAttribute("rotation", data.rotation);
      piano.setAttribute("scale", data.scale);
    }

    const step = 0.02;
    const rotStep = 2;
    const scaleStep = 0.02;

    function save() {
      localStorage.setItem("pianoCalibration", JSON.stringify({
        position: piano.getAttribute("position"),
        rotation: piano.getAttribute("rotation"),
        scale: piano.getAttribute("scale")
      }));

      alert("Calibration Saved!");
    }

    // Button actions

    window.calibrate = {

      left: () => move(-step, 0, 0),
      right: () => move(step, 0, 0),

      forward: () => move(0, 0, -step),
      back: () => move(0, 0, step),

      up: () => move(0, step, 0),
      down: () => move(0, -step, 0),

      rotateLeft: () => rotate(-rotStep),
      rotateRight: () => rotate(rotStep),

      scaleUp: () => scale(scaleStep),
      scaleDown: () => scale(-scaleStep),

      save: save
    };

    function move(x, y, z) {
      let p = piano.getAttribute("position");
      piano.setAttribute("position", {
        x: p.x + x,
        y: p.y + y,
        z: p.z + z
      });
    }

    function rotate(yaw) {
      let r = piano.getAttribute("rotation");
      piano.setAttribute("rotation", {
        x: r.x,
        y: r.y + yaw,
        z: r.z
      });
    }

    function scale(amount) {
      let s = piano.getAttribute("scale");
      piano.setAttribute("scale", {
        x: s.x + amount,
        y: s.y + amount,
        z: s.z + amount
      });
    }
  }
});


// -------- SIMPLE PIANO --------

AFRAME.registerComponent('simple-piano', {
  init: function () {

    const root = this.el;

    const whiteKeyWidth = 0.022;

    let whiteIndex = 0;

    for (let i = 0; i < 52; i++) {

      let key = document.createElement("a-box");

      key.setAttribute("width", whiteKeyWidth);
      key.setAttribute("height", 0.1);
      key.setAttribute("depth", 0.15);
      key.setAttribute("color", "white");

      key.setAttribute(
        "position",
        `${whiteIndex * whiteKeyWidth} 1.2 -1`
      );

      whiteIndex++;

      root.appendChild(key);
    }
  }
});


// -------- BUTTON COMPONENT --------

AFRAME.registerComponent('ui-button', {
  schema: {
    action: {type: 'string'}
  },

  init: function () {

    this.el.addEventListener("click", () => {
      const action = this.data.action;
      window.calibrate[action]();
    });

    this.el.setAttribute("class", "clickable");
  }
});

</script>

<a-scene vr-calibrator>

  <!-- Controllers -->
  <a-entity laser-controls="hand: right" raycaster="objects: .clickable"></a-entity>
  <a-entity laser-controls="hand: left" raycaster="objects: .clickable"></a-entity>

  <a-camera position="0 1.6 0"></a-camera>

  <!-- Piano -->
  <a-entity id="pianoRoot" simple-piano></a-entity>

  <!-- Calibration Panel -->

  <a-entity position="0 1.5 -0.8">

    <a-text value="PIANO CALIBRATION"
            position="-0.3 0.3 0"
            color="yellow"></a-text>

    <!-- Movement -->

    <a-box ui-button="action:left" position="-0.3 0 0"
           color="red" depth="0.05" height="0.1" width="0.1"></a-box>

    <a-box ui-button="action:right" position="-0.1 0 0"
           color="red" depth="0.05" height="0.1" width="0.1"></a-box>

    <a-box ui-button="action:forward" position="0.1 0 0"
           color="blue" depth="0.05" height="0.1" width="0.1"></a-box>

    <a-box ui-button="action:back" position="0.3 0 0"
           color="blue" depth="0.05" height="0.1" width="0.1"></a-box>

    <!-- Up Down -->

    <a-box ui-button="action:up" position="-0.3 -0.15 0"
           color="green" depth="0.05" height="0.1" width="0.1"></a-box>

    <a-box ui-button="action:down" position="-0.1 -0.15 0"
           color="green" depth="0.05" height="0.1" width="0.1"></a-box>

    <!-- Rotate -->

    <a-box ui-button="action:rotateLeft" position="0.1 -0.15 0"
           color="purple" depth="0.05" height="0.1" width="0.1"></a-box>

    <a-box ui-button="action:rotateRight" position="0.3 -0.15 0"
           color="purple" depth="0.05" height="0.1" width="0.1"></a-box>

    <!-- Scale -->

    <a-box ui-button="action:scaleUp" position="-0.3 -0.3 0"
           color="orange" depth="0.05" height="0.1" width="0.1"></a-box>

    <a-box ui-button="action:scaleDown" position="-0.1 -0.3 0"
           color="orange" depth="0.05" height="0.1" width="0.1"></a-box>

    <!-- Save -->

    <a-box ui-button="action:save" position="0.3 -0.3 0"
           color="yellow" depth="0.05" height="0.1" width="0.2"></a-box>

    <a-text value="SAVE"
            position="0.26 -0.3 0.04"
            color="black"></a-text>

  </a-entity>

</a-scene>

</body>
</html>
