<!DOCTYPE html>
<html>
<head>
    <title>Quest VR Piano - A-Button Calibration</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://surikov.github.io/webaudiofont/npm/dist/WebAudioFontPlayer.js"></script>
    <script src="https://surikov.github.io/webaudiofontdata/sound/0000_Aspirin_sf2_file.js"></script>
</head>
<body>

    <a-scene renderer="colorManagement: true;">
        
        <a-entity id="piano-wrapper" position="0 1.2 -0.5">
            <a-entity id="piano-keys"></a-entity>
        </a-entity>

        <a-entity id="ui-panel" position="0 1.5 -0.6">
            <a-plane color="#111" width="0.8" height="0.5" opacity="0.9" rotation="-10 0 0">
                <a-text id="status-text" value="1. Click START (Laser)\n2. Hold 'A' Button to Move Piano\n3. Click LOCK when done" 
                        align="center" position="0 0.15 0.01" width="0.7"></a-text>
                
                <a-circle id="start-btn" class="raycastable" position="0 -0.1 0.02" radius="0.08" color="#4CAF50">
                    <a-text value="START" align="center" width="0.8" position="0 0 0.01"></a-text>
                </a-circle>

                <a-circle id="lock-btn" class="raycastable" position="0 -0.1 0.02" radius="0.08" color="#2196F3" visible="false">
                    <a-text value="LOCK" align="center" width="0.8" position="0 0 0.01"></a-text>
                </a-circle>

                <a-plane id="reset-btn" class="raycastable" position="0 -0.22 0.01" width="0.3" height="0.05" color="#444" visible="false">
                    <a-text value="RE-CALIBRATE" align="center" width="0.4"></a-text>
                </a-plane>
            </a-plane>
        </a-entity>

        <a-entity id="leftHand" laser-controls="hand: left" raycaster="objects: .raycastable; far: 5"></a-entity>
        <a-entity id="rightHand" laser-controls="hand: right" raycaster="objects: .raycastable; far: 5"></a-entity>

        <a-camera position="0 1.6 0"></a-camera>
    </a-scene>

    <script>
        let audioCtx = null;
        let player = new WebAudioFontPlayer();
        let pianoInstrument = _tone_0000_Aspirin_sf2_file;
        
        let isGrabbing = false;
        let isLocked = false;

        const wrapper = document.getElementById('piano-wrapper');
        const startBtn = document.getElementById('start-btn');
        const lockBtn = document.getElementById('lock-btn');
        const resetBtn = document.getElementById('reset-btn');
        const statusText = document.getElementById('status-text');
        const rightHand = document.getElementById('rightHand');

        // 1. GENERATE 88-KEY PIANO
        function initPiano() {
            const container = document.querySelector('#piano-keys');
            const totalWidth = 1.22; 
            const whiteKeyCount = 52;
            const keyWidth = totalWidth / whiteKeyCount;
            const blackKeyPattern = [1, 1, 0, 1, 1, 1, 0];
            let currentMidi = 21; 

            for (let i = 0; i < whiteKeyCount; i++) {
                addKey(container, (i * keyWidth) - (totalWidth/2), 0, 0, keyWidth * 0.9, 0.03, 0.25, 'white', currentMidi);
                let note = currentMidi % 12;
                currentMidi += ([4, 11].includes(note)) ? 1 : 2;
            }

            currentMidi = 22;
            for (let i = 0; i < 51; i++) {
                let octavePos = (i + 5) % 7;
                if (blackKeyPattern[octavePos] === 1) {
                    addKey(container, ((i + 0.5) * keyWidth) - (totalWidth/2), 0.02, -0.08, keyWidth * 0.6, 0.05, 0.15, 'black', currentMidi);
                }
                let note = currentMidi % 12;
                currentMidi += ([1, 3, 6, 8, 10].includes(note)) ? 2 : 1;
            }
        }

        function addKey(parent, x, y, z, w, h, d, color, midi) {
            let key = document.createElement('a-box');
            key.setAttribute('class', 'raycastable');
            key.setAttribute('position', `${x} ${y} ${z}`);
            key.setAttribute('width', w); key.setAttribute('height', h); key.setAttribute('depth', d);
            key.setAttribute('color', color);
            key.setAttribute('piano-key', `midi: ${midi}; orig: ${color}`);
            parent.appendChild(key);
        }

        // 2. BUTTON LOGIC
        startBtn.addEventListener('click', () => {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                player.loader.decodeAfterLoading(audioCtx, '_tone_0000_Aspirin_sf2_file');
                startBtn.setAttribute('visible', 'false');
                startBtn.setAttribute('class', 'not-clickable');
                lockBtn.setAttribute('visible', 'true');
                statusText.setAttribute('value', "AUDIO ON\nHold 'A' button on Right Controller\nto move piano. Click LOCK to finish.");
            }
        });

        lockBtn.addEventListener('click', () => {
            isLocked = true;
            isGrabbing = false;
            lockBtn.setAttribute('visible', 'false');
            lockBtn.setAttribute('class', 'not-clickable');
            resetBtn.setAttribute('visible', 'true');
            statusText.setAttribute('value', "LOCKED");
            setTimeout(() => { 
                // Hide main panel but keep reset button area potentially accessible
                statusText.setAttribute('value', "Piano Aligned.");
            }, 2000);
        });

        resetBtn.addEventListener('click', () => {
            isLocked = false;
            lockBtn.setAttribute('visible', 'true');
            lockBtn.setAttribute('class', 'raycastable');
            resetBtn.setAttribute('visible', 'false');
            statusText.setAttribute('value', "RE-CALIBRATING\nHold 'A' to move.");
        });

        // 3. PHYSICAL BUTTON GRAB LOGIC (Right Controller 'A')
        rightHand.addEventListener('abuttondown', () => {
            if (!isLocked) isGrabbing = true;
        });

        rightHand.addEventListener('abuttonup', () => {
            isGrabbing = false;
        });

        AFRAME.registerComponent('piano-mover', {
            tick: function () {
                if (isGrabbing && !isLocked) {
                    let controllerPos = new THREE.Vector3();
                    let controllerQuat = new THREE.Quaternion();
                    
                    rightHand.object3D.getWorldPosition(controllerPos);
                    rightHand.object3D.getWorldQuaternion(controllerQuat);
                    
                    wrapper.object3D.position.copy(controllerPos);
                    wrapper.object3D.quaternion.copy(controllerQuat);
                }
            }
        });
        document.querySelector('a-scene').setAttribute('piano-mover', '');

        // 4. KEY COMPONENT
        AFRAME.registerComponent('piano-key', {
            schema: { midi: {type: 'int'}, orig: {type: 'string'} },
            init: function () {
                this.el.addEventListener('mousedown', () => {
                    if (audioCtx && isLocked) { // Only play if locked or you'll play while moving
                        player.queueWaveTable(audioCtx, audioCtx.destination, pianoInstrument, audioCtx.currentTime, this.data.midi, 1.0);
                        this.el.setAttribute('color', 'yellow');
                        setTimeout(() => this.el.setAttribute('color', this.data.orig), 150);
                    }
                });
            }
        });

        window.onload = initPiano;
    </script>
</body>
</html>
