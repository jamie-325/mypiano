<!DOCTYPE html>
<html>
<head>
    <title>Quest MR Piano - Passthrough & Calibration</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://surikov.github.io/webaudiofont/npm/dist/WebAudioFontPlayer.js"></script>
    <script src="https://surikov.github.io/webaudiofontdata/sound/0000_Aspirin_sf2_file.js"></script>
</head>
<body>

    <a-scene xr-mode-ui="enabled: true" renderer="alpha: true; colorManagement: true;">
        
        <a-entity id="piano-wrapper">
            <a-entity id="piano-keys"></a-entity>
        </a-entity>

        <a-entity id="start-screen" position="0 1.5 -1">
            <a-plane color="#111" width="1" height="0.6" opacity="0.9">
                <a-text value="1. ENTER VR MODE\n2. Point & Click START" align="center" position="0 0.1 0.01" width="0.8"></a-text>
                <a-box id="audio-unlock-btn" class="raycastable" position="0 -0.15 0.02" width="0.4" height="0.15" depth="0.02" color="#4CAF50">
                    <a-text value="START" align="center" width="1" position="0 0 0.02"></a-text>
                </a-box>
            </a-plane>
        </a-entity>

        <a-entity id="menu" position="0 1.5 -1" visible="false">
            <a-plane color="#222" width="1.2" height="0.6" opacity="0.9">
                <a-text id="status-text" value="Ready to match your real piano?" align="center" position="0 0.18 0.01" width="1"></a-text>
                
                <a-box id="calib-btn" class="raycastable" position="0 0 0.02" width="0.5" height="0.12" color="#2196F3">
                    <a-text value="START CALIBRATION" align="center" width="0.5" position="0 0 0.02"></a-text>
                </a-box>

                <a-box id="confirm-btn" class="raycastable" position="0.3 -0.18 0.02" width="0.4" height="0.12" color="#4CAF50" visible="false">
                    <a-text value="CONFIRM" align="center" width="0.5" position="0 0 0.02"></a-text>
                </a-box>

                <a-box id="reset-btn" class="raycastable" position="-0.3 -0.18 0.02" width="0.4" height="0.12" color="#f44336" visible="false">
                    <a-text value="RE-CALIBRATE" align="center" width="0.5" position="0 0 0.02"></a-text>
                </a-box>
            </a-plane>
        </a-entity>

        <a-entity id="rig">
            <a-camera position="0 1.6 0"></a-camera>
            <a-entity id="leftHand" laser-controls="hand: left" raycaster="objects: .raycastable; far: 10"></a-entity>
            <a-entity id="rightHand" laser-controls="hand: right" raycaster="objects: .raycastable; far: 10"></a-entity>
        </a-entity>

        <a-sphere id="markerL" radius="0.01" color="red" visible="false"></a-sphere>
        <a-sphere id="markerR" radius="0.01" color="blue" visible="false"></a-sphere>

    </a-scene>

    <script>
        let audioCtx = null;
        let player = new WebAudioFontPlayer();
        let pianoInstrument = _tone_0000_Aspirin_sf2_file;
        let calibStep = 0; 
        let posL = new THREE.Vector3();
        let posR = new THREE.Vector3();

        const menu = document.getElementById('menu');
        const statusText = document.getElementById('status-text');
        const confirmBtn = document.getElementById('confirm-btn');
        const resetBtn = document.getElementById('reset-btn');
        const calibBtn = document.getElementById('calib-btn');

        // --- PASSTHROUGH LOGIC ---
        // This triggers when entering VR mode
        document.querySelector('a-scene').addEventListener('enter-vr', () => {
            const sceneEl = document.querySelector('a-scene');
            // Request Passthrough for Quest
            if (sceneEl.hasWebXR) {
                sceneEl.renderer.setClearColor(0x000000, 0);
                // Standard A-Frame passthrough helper
                sceneEl.setAttribute('environment', 'active: false');
            }
        });

        // --- 1. START AUDIO & UNLOCK VR ---
        document.getElementById('audio-unlock-btn').addEventListener('click', () => {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                player.loader.decodeAfterLoading(audioCtx, '_tone_0000_Aspirin_sf2_file');
                document.getElementById('start-screen').setAttribute('visible', 'false');
                menu.setAttribute('visible', 'true');
            }
        });

        // --- 2. CALIBRATION STEPS ---
        calibBtn.addEventListener('click', () => {
            calibStep = 1;
            calibBtn.setAttribute('visible', 'false');
            statusText.setAttribute('value', 'STEP 1:\nTouch REAL LOW A with controller tip\nand pull Trigger');
        });

        resetBtn.addEventListener('click', () => {
            calibStep = 1;
            confirmBtn.setAttribute('visible', 'false');
            resetBtn.setAttribute('visible', 'false');
            statusText.setAttribute('value', 'RE-CALIBRATING...\nTouch REAL LOW A and pull Trigger');
        });

        confirmBtn.addEventListener('click', () => {
            menu.setAttribute('visible', 'false');
            // Show a temporary "Locked" message or just hide
        });

        window.addEventListener('triggerdown', (evt) => {
            if (calibStep === 0) return;
            let controllerPos = new THREE.Vector3();
            evt.target.object3D.getWorldPosition(controllerPos);

            if (calibStep === 1) {
                posL.copy(controllerPos);
                mark('markerL', posL);
                calibStep = 2;
                statusText.setAttribute('value', 'STEP 2:\nTouch REAL HIGH C with controller tip\nand pull Trigger');
            } 
            else if (calibStep === 2) {
                posR.copy(controllerPos);
                mark('markerR', posR);
                applyCalibration();
                calibStep = 0;
                statusText.setAttribute('value', 'ALIGNED!\nIs the virtual piano correct?');
                confirmBtn.setAttribute('visible', 'true');
                resetBtn.setAttribute('visible', 'true');
            }
        });

        function mark(id, pos) {
            const m = document.getElementById(id);
            m.setAttribute('position', pos); m.setAttribute('visible', 'true');
        }

        function applyCalibration() {
            const wrapper = document.querySelector('#piano-wrapper');
            wrapper.object3D.position.copy(posL);
            let direction = new THREE.Vector3().subVectors(posR, posL);
            let distance = posL.distanceTo(posR);
            let angle = Math.atan2(direction.x, direction.z);
            wrapper.object3D.rotation.y = angle - Math.PI/2;
            buildPiano(distance);
        }

        // --- PIANO GENERATION ---
        function buildPiano(totalWidth) {
            const container = document.querySelector('#piano-keys');
            container.innerHTML = ''; 
            const whiteKeyCount = 52;
            const keyWidth = totalWidth / whiteKeyCount;
            const blackKeyPattern = [1, 1, 0, 1, 1, 1, 0];
            let currentMidi = 21; 

            for (let i = 0; i < whiteKeyCount; i++) {
                addKey(container, i * keyWidth, 0, 0, keyWidth * 0.9, 0.04, 0.25, 'white', currentMidi);
                let note = currentMidi % 12;
                currentMidi += ([4, 11].includes(note)) ? 1 : 2;
            }

            currentMidi = 22;
            for (let i = 0; i < 51; i++) {
                let octavePos = (i + 5) % 7;
                if (blackKeyPattern[octavePos] === 1) {
                    addKey(container, (i + 0.5) * keyWidth, 0.03, -0.08, keyWidth * 0.6, 0.06, 0.15, 'black', currentMidi);
                }
                let note = currentMidi % 12;
                currentMidi += ([1, 3, 6, 8, 10].includes(note)) ? 2 : 1;
            }
        }

        function addKey(parent, x, y, z, w, h, d, color, midi) {
            let key = document.createElement('a-box');
            key.setAttribute('class', 'raycastable');
            key.setAttribute('position', `${x} ${y} ${z}`);
            key.setAttribute('width', w); key.setAttribute('height', h); key.setAttribute('depth', d);
            key.setAttribute('color', color);
            key.setAttribute('opacity', 0.7); // Transparent so you see real keys through them
            key.setAttribute('piano-key', `midi: ${midi}; orig: ${color}`);
            parent.appendChild(key);
        }

        AFRAME.registerComponent('piano-key', {
            schema: { midi: {type: 'int'}, orig: {type: 'string'} },
            init: function () {
                this.el.addEventListener('mousedown', () => {
                    if (audioCtx) {
                        player.queueWaveTable(audioCtx, audioCtx.destination, pianoInstrument, audioCtx.currentTime, this.data.midi, 1.0);
                        this.el.setAttribute('color', 'yellow');
                        setTimeout(() => this.el.setAttribute('color', this.data.orig), 150);
                    }
                });
            }
        });
    </script>
</body>
</html>
