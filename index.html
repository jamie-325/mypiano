<!DOCTYPE html>
<html>
<head>
  <title>Real Piano 88 Keys - VR Movement</title>

  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  
  <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.2.0/dist/aframe-extras.min.js"></script>

  <script src="https://surikov.github.io/webaudiofont/npm/dist/WebAudioFontPlayer.js"></script>
  <script src="https://surikov.github.io/webaudiofontdata/sound/0000_Aspirin_sf2_file.js"></script>
</head>

<body>
  <a-scene webxr="requiredFeatures: local-floor">

    <a-entity id="rig" movement-controls="fly: false; speed: 0.15" position="0 0 1">
      <a-camera position="0 1.6 0" look-controls>
        <a-cursor raycaster="objects: [piano-key]"></a-cursor>
      </a-camera>

      <a-entity oculus-touch-controls="hand: left"></a-entity>
      <a-entity oculus-touch-controls="hand: right" raycaster="objects: [piano-key]; showLine: true"></a-entity>
    </a-entity>

    <a-entity id="piano" position="-2.5 0.8 -0.5"></a-entity>

    <a-grid></a-grid>

  </a-scene>

  <script>
    // ----------- REAL PIANO AUDIO SETUP -----------
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const player = new WebAudioFontPlayer();
    const pianoInstrument = _tone_0000_Aspirin_sf2_file;
    player.loader.decodeAfterLoading(audioCtx, '_tone_0000_Aspirin_sf2_file');

    function playRealPiano(midiNote) {
      // Resume audio context in case browser blocked it
      if (audioCtx.state === 'suspended') audioCtx.resume();
      
      player.queueWaveTable(audioCtx, audioCtx.destination, pianoInstrument, audioCtx.currentTime, midiNote, 1.5);
    }

    // ----------- PIANO KEY COMPONENT -----------
    AFRAME.registerComponent('piano-key', {
      schema: {
        color: { default: 'white' },
        midi: { default: 60 }
      },
      init: function () {
        const el = this.el;
        const originalColor = this.data.color;
        const midiNote = this.data.midi;

        el.addEventListener('mousedown', () => { // Using mousedown for faster response
          el.setAttribute('color', 'yellow');
          playRealPiano(midiNote);
          setTimeout(() => {
            el.setAttribute('color', originalColor);
          }, 150);
        });
      }
    });

    // ----------- BUILD FULL 88-KEY PIANO -----------
    function createPiano() {
      const piano = document.querySelector('#piano');
      const whiteKeyWidth = 0.1;
      const whiteKeyHeight = 0.05;
      const whiteKeyDepth = 0.4;
      const blackKeyWidth = 0.06;
      const blackKeyHeight = 0.08;
      const blackKeyDepth = 0.25;
      const blackKeyPattern = [1, 1, 0, 1, 1, 1, 0];
      const whiteKeyCount = 52;

      let currentMidi = 21; 

      for (let i = 0; i < whiteKeyCount; i++) {
        let key = document.createElement('a-box');
        key.setAttribute('width', whiteKeyWidth);
        key.setAttribute('height', whiteKeyHeight);
        key.setAttribute('depth', whiteKeyDepth);
        key.setAttribute('position', `${i * whiteKeyWidth} 0 0`);
        key.setAttribute('color', 'white');
        key.setAttribute('piano-key', `color: white; midi: ${currentMidi}`);
        key.setAttribute('class', 'clickable'); // Added class for raycaster
        piano.appendChild(key);

        const noteInOctave = currentMidi % 12;
        currentMidi += ([4, 11].includes(noteInOctave)) ? 1 : 2;
      }

      currentMidi = 22; 
      for (let i = 0; i < whiteKeyCount - 1; i++) {
        let octavePosition = i % 7;
        if (blackKeyPattern[octavePosition] === 1) {
          let blackKey = document.createElement('a-box');
          blackKey.setAttribute('width', blackKeyWidth);
          blackKey.setAttribute('height', blackKeyHeight);
          blackKey.setAttribute('depth', blackKeyDepth);
          blackKey.setAttribute('position', `${(i + 0.75) * whiteKeyWidth} 0.03 -0.05`);
          blackKey.setAttribute('color', 'black');
          blackKey.setAttribute('piano-key', `color: black; midi: ${currentMidi}`);
          blackKey.setAttribute('class', 'clickable');
          piano.appendChild(blackKey);
        }
        const noteInOctave = currentMidi % 12;
        currentMidi += ([1, 3, 6, 8, 10].includes(noteInOctave)) ? 2 : 1;
      }
    }

    window.onload = createPiano;
  </script>
</body>
</html>
