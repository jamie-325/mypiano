<!DOCTYPE html>
<html>
<head>
  <title>Real Piano 88 Keys - Mouse & VR</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.2.0/dist/aframe-extras.min.js"></script>
  <script src="https://surikov.github.io/webaudiofont/npm/dist/WebAudioFontPlayer.js"></script>
  <script src="https://surikov.github.io/webaudiofontdata/sound/0000_Aspirin_sf2_file.js"></script>
</head>

<body>
  <a-scene cursor="rayOrigin: mouse" raycaster="objects: .clickable">

    <a-entity id="rig" movement-controls="fly: false; speed: 0.05; acceleration: 20" position="0 0 1">
      <a-camera position="0 1.6 0" look-controls></a-camera>
      
      <a-entity oculus-touch-controls="hand: left"></a-entity>
      <a-entity oculus-touch-controls="hand: right" laser-controls="hand: right" raycaster="objects: .clickable"></a-entity>
    </a-entity>

    <a-entity id="piano" position="-2.5 0.8 -0.5"></a-entity>

    <a-sky color="#ECECEC"></a-sky>
    <a-plane position="0 0 0" rotation="-90 0 0" width="20" height="20" color="#7BC8A4"></a-plane>

  </a-scene>

  <script>
    // ----------- AUDIO SETUP -----------
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const player = new WebAudioFontPlayer();
    const pianoInstrument = _tone_0000_Aspirin_sf2_file;
    player.loader.decodeAfterLoading(audioCtx, '_tone_0000_Aspirin_sf2_file');

    function playRealPiano(midiNote) {
      if (audioCtx.state === 'suspended') audioCtx.resume();
      player.queueWaveTable(audioCtx, audioCtx.destination, pianoInstrument, audioCtx.currentTime, midiNote, 1.5);
    }

    // ----------- PIANO KEY COMPONENT -----------
    AFRAME.registerComponent('piano-key', {
      schema: { color: { default: 'white' }, midi: { default: 60 } },
      init: function () {
        const el = this.el;
        const originalColor = this.data.color;

        // Mouse or Controller Click
        el.addEventListener('mousedown', () => {
          el.setAttribute('color', 'yellow');
          playRealPiano(this.data.midi);
          
          // Visual "Press" Animation
          el.object3D.position.y -= 0.01;

          setTimeout(() => {
            el.setAttribute('color', originalColor);
            el.object3D.position.y += 0.01;
          }, 150);
        });

        // Hover effect for clarity
        el.addEventListener('mouseenter', () => {
          el.setAttribute('color', '#D3D3D3');
        });
        el.addEventListener('mouseleave', () => {
          el.setAttribute('color', originalColor);
        });
      }
    });

    // ----------- BUILD PIANO -----------
    function createPiano() {
      const piano = document.querySelector('#piano');
      const whiteKeyWidth = 0.1;
      const whiteNotes = [0, 2, 4, 5, 7, 9, 11];
      let midiPointer = 21; 

      for (let i = 0; i < 52; i++) {
        // White Keys
        let key = document.createElement('a-box');
        key.setAttribute('class', 'clickable'); // Essential for raycaster
        key.setAttribute('width', 0.095);
        key.setAttribute('height', 0.05);
        key.setAttribute('depth', 0.4);
        key.setAttribute('position', `${i * whiteKeyWidth} 0 0`);
        
        while (!whiteNotes.includes(midiPointer % 12)) midiPointer++;
        
        key.setAttribute('piano-key', `color: white; midi: ${midiPointer}`);
        piano.appendChild(key);
        
        // Black Keys
        let noteInOctave = midiPointer % 12;
        if (noteInOctave !== 4 && noteInOctave !== 11 && i < 51) {
          let blackKey = document.createElement('a-box');
          blackKey.setAttribute('class', 'clickable');
          blackKey.setAttribute('width', 0.06);
          blackKey.setAttribute('height', 0.08);
          blackKey.setAttribute('depth', 0.25);
          blackKey.setAttribute('position', `${(i * whiteKeyWidth) + (whiteKeyWidth / 2)} 0.03 -0.1`);
          blackKey.setAttribute('color', 'black');
          blackKey.setAttribute('piano-key', `color: black; midi: ${midiPointer + 1}`);
          piano.appendChild(blackKey);
        }
        midiPointer++;
      }
    }

    window.onload = createPiano;
  </script>
</body>
</html>
