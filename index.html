<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>VR Synthesia Piano</title>
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
</head>

<body>
<a-scene background="color:#111" xr-mode-ui="enabled:true">

  <!-- Camera -->
  <a-camera position="0 1.6 2">
    <a-cursor fuse="true" fuse-timeout="600"></a-cursor>
  </a-camera>

  <!-- Hit Line -->
  <a-plane position="0 0.02 -3"
           width="20"
           height="0.01"
           color="#ffffff"
           opacity="0.7">
  </a-plane>

  <!-- Piano Container -->
  <a-entity id="piano" position="0 0 -3"></a-entity>

  <!-- Roll Container -->
  <a-entity id="roll" position="0 0 -3"></a-entity>

  <!-- VR Buttons -->
  <a-box id="btnRecord" position="-1.5 1.4 -2"
         width="0.5" height="0.2" depth="0.1"
         color="#aa0000"></a-box>

  <a-box id="btnStop" position="-0.8 1.4 -2"
         width="0.5" height="0.2" depth="0.1"
         color="#555"></a-box>

  <a-box id="btnPlay" position="-0.1 1.4 -2"
         width="0.5" height="0.2" depth="0.1"
         color="#0066aa"></a-box>

  <a-entity position="-1.5 1.4 -1.9"
    text="value:REC; align:center; width:2; color:#fff"></a-entity>

  <a-entity position="-0.8 1.4 -1.9"
    text="value:STOP; align:center; width:2; color:#fff"></a-entity>

  <a-entity position="-0.1 1.4 -1.9"
    text="value:PLAY; align:center; width:2; color:#fff"></a-entity>

</a-scene>

<script>

const START_NOTE = 21;
const END_NOTE = 108;
const WHITE_WIDTH = 0.12;
const BLACK_WIDTH = 0.07;
const BLACK_HEIGHT = 0.15;
const WHITE_HEIGHT = 0.2;
const FALL_SPEED = 1.5;
const BPM = 120;

const piano = document.querySelector('#piano');
const roll = document.querySelector('#roll');

let keyMap = {};
let keyPos = {};
let isRecording = false;
let isPlaying = false;
let recordStart = 0;
let playStart = 0;
let recording = [];

const isBlack = n => [1,3,6,8,10].includes(n % 12);
const isRightHand = n => n >= 60;

// ───────── BUILD 88 KEY PIANO ─────────

let whiteIndex = 0;

for(let n = START_NOTE; n <= END_NOTE; n++){

  const key = document.createElement('a-box');
  key.dataset.note = n;

  if(!isBlack(n)){
    key.setAttribute('width', WHITE_WIDTH);
    key.setAttribute('height', WHITE_HEIGHT);
    key.setAttribute('depth', 0.8);
    key.setAttribute('color', '#fff');
    key.setAttribute('position',{
      x: whiteIndex * WHITE_WIDTH,
      y: 0,
      z: 0
    });
    keyPos[n] = whiteIndex * WHITE_WIDTH;
    whiteIndex++;
  } else {
    key.setAttribute('width', BLACK_WIDTH);
    key.setAttribute('height', BLACK_HEIGHT);
    key.setAttribute('depth', 0.5);
    key.setAttribute('color', '#000');
    key.setAttribute('position',{
      x: (whiteIndex - 1) * WHITE_WIDTH + WHITE_WIDTH/2,
      y: 0.05,
      z: -0.15
    });
    keyPos[n] = (whiteIndex - 1) * WHITE_WIDTH + WHITE_WIDTH/2;
  }

  piano.appendChild(key);
  keyMap[n] = key;
}

piano.object3D.position.x = -(whiteIndex * WHITE_WIDTH)/2;

// ───────── MIDI SETUP ─────────

navigator.requestMIDIAccess?.().then(access=>{
  access.inputs.forEach(input=>{
    input.onmidimessage = handleMIDI;
  });
});

function handleMIDI(event){
  const [status,note,velocity] = event.data;
  const type = status & 0xf0;

  if(type===0x90 && velocity>0) noteOn(note,velocity);
  if(type===0x80 || (type===0x90 && velocity===0)) noteOff(note);
}

let activeNotes = {};

function noteOn(note,velocity){
  keyMap[note]?.setAttribute('color','#22c55e');

  activeNotes[note] = {
    time: performance.now()
  };

  if(isRecording){
    recording.push({
      type:'on',
      midi:note,
      velocity,
      time:(performance.now()-recordStart)/1000
    });
  }
}

function noteOff(note){
  keyMap[note]?.setAttribute('color', isBlack(note)?'#000':'#fff');

  if(isRecording){
    recording.push({
      type:'off',
      midi:note,
      time:(performance.now()-recordStart)/1000
    });
  }
}

// ───────── RECORD / PLAY / STOP ─────────

document.querySelector('#btnRecord').onclick = ()=>{
  recording = [];
  isRecording = true;
  isPlaying = false;
  recordStart = performance.now();
};

document.querySelector('#btnStop').onclick = ()=>{
  isRecording = false;
  isPlaying = false;
};

document.querySelector('#btnPlay').onclick = ()=>{
  if(!recording.length) return;
  isPlaying = true;
  isRecording = false;
  playStart = performance.now();
  buildRoll();
};

// ───────── BUILD SYNTHESIA ROLL ─────────

function buildRoll(){

  roll.innerHTML = "";
  const active = {};

  recording.forEach(ev=>{
    if(ev.type==='on') active[ev.midi]=ev;
    if(ev.type==='off' && active[ev.midi]){
      const onEv = active[ev.midi];
      createNote(ev.midi,onEv.time,ev.time-onEv.time);
      delete active[ev.midi];
    }
  });

  createBeatGrid();
}

function createNote(midi,start,duration){

  const note = document.createElement('a-box');

  note.setAttribute('width', isBlack(midi)?BLACK_WIDTH:WHITE_WIDTH);
  note.setAttribute('depth',0.15);
  note.setAttribute('height', duration*FALL_SPEED);
  note.setAttribute('color',
    isRightHand(midi)?'#38bdf8':'#a78bfa');

  note.dataset.start = start;
  note.dataset.duration = duration;
  note.dataset.midi = midi;

  roll.appendChild(note);
}

function createBeatGrid(){
  const secondsPerBeat = 60/BPM;
  const totalTime = Math.max(...recording.map(e=>e.time));

  for(let t=0;t<totalTime;t+=secondsPerBeat){
    const line=document.createElement('a-plane');
    line.setAttribute('width',20);
    line.setAttribute('height',0.005);
    line.setAttribute('color','#444');
    line.dataset.time=t;
    roll.appendChild(line);
  }
}

// ───────── FALLING ENGINE ─────────

document.querySelector('a-scene')
.addEventListener('tick',()=>{

  if(!isPlaying) return;

  const currentTime =
    (performance.now()-playStart)/1000;

  roll.childNodes.forEach(obj=>{

    if(obj.tagName==='A-BOX'){

      const start=parseFloat(obj.dataset.start);
      const duration=parseFloat(obj.dataset.duration);
      const midi=obj.dataset.midi;

      const y=(start-currentTime)*FALL_SPEED;

      obj.setAttribute('position',{
        x:keyPos[midi]-(whiteIndex*WHITE_WIDTH)/2,
        y:y+(duration*FALL_SPEED)/2,
        z:0
      });

      if(Math.abs(y)<0.02){
        keyMap[midi]
          ?.setAttribute('color','#facc15');
      }

      if(y+duration*FALL_SPEED<-1){
        obj.remove();
      }
    }

    if(obj.tagName==='A-PLANE'){
      const y=(obj.dataset.time-currentTime)
              *FALL_SPEED;
      obj.setAttribute('position',{
        x:0,
        y:y,
        z:-0.05
      });
    }

  });

});

</script>
</body>
</html>
