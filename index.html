<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>VR MIDI Recorder</title>
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
</head>

<body>

<a-scene id="scene" xr-mode-ui="enabled:true" background="color:#111">

  <!-- Treble Staff -->
  <a-entity id="trebleLane" position="0 2.4 -3"></a-entity>

  <!-- Bass Staff -->
  <a-entity id="bassLane" position="0 1.2 -3"></a-entity>

  <!-- Staff Labels -->
  <a-entity position="-2 2.6 -3"
            text="value:ð„ž Treble; width:4; color:#fff">
  </a-entity>

  <a-entity position="-2 1.4 -3"
            text="value:ð„¢ Bass; width:4; color:#fff">
  </a-entity>

  <!-- Record Button -->
  <a-box id="recordBtn"
         position="-1 3 -3"
         depth="0.2" height="0.4" width="1"
         color="#880000">
  </a-box>

  <a-entity position="-1 3 -2.8"
            text="value:RECORD; align:center; width:4; color:#fff">
  </a-entity>

  <!-- Play Button -->
  <a-box id="playBtn"
         position="1 3 -3"
         depth="0.2" height="0.4" width="1"
         color="#006600">
  </a-box>

  <a-entity position="1 3 -2.8"
            text="value:PLAY; align:center; width:4; color:#fff">
  </a-entity>

  <!-- Piano -->
  <a-entity id="piano" position="0 0.6 -3"></a-entity>

  <a-camera position="0 1.6 0">
    <a-cursor fuse="true" fuse-timeout="700"></a-cursor>
  </a-camera>

</a-scene>

<script>
window.addEventListener("load", () => {

const scene = document.querySelector("#scene");
const piano = document.querySelector("#piano");
const trebleLane = document.querySelector("#trebleLane");
const bassLane = document.querySelector("#bassLane");
const recordBtn = document.querySelector("#recordBtn");
const playBtn = document.querySelector("#playBtn");

const START_NOTE = 21;
const END_NOTE = 108;
const WHITE_WIDTH = 0.12;
const MIDDLE_C = 60;
const SCROLL_SPEED = 0.01;

window.midiState = {
  activeNotes: {},
  recorded: [],
  recording: false,
  playing: false
};

let recordStart = 0;
let playbackStart = 0;

// ---------- BUILD PIANO ----------
let whiteIndex = 0;
const keyMap = {};

for (let n = START_NOTE; n <= END_NOTE; n++) {

  const isBlack = [1,3,6,8,10].includes(n % 12);
  const key = document.createElement("a-box");
  key.dataset.note = n;

  if (!isBlack) {
    key.setAttribute("width", WHITE_WIDTH);
    key.setAttribute("height", 0.2);
    key.setAttribute("depth", 1);
    key.setAttribute("color", "#fff");

    key.setAttribute("position", {
      x: whiteIndex * WHITE_WIDTH,
      y: 0,
      z: 0
    });

    whiteIndex++;
  } else {
    key.setAttribute("width", 0.07);
    key.setAttribute("height", 0.15);
    key.setAttribute("depth", 0.6);
    key.setAttribute("color", "#000");

    key.setAttribute("position", {
      x: (whiteIndex - 1) * WHITE_WIDTH + WHITE_WIDTH/2,
      y: 0.05,
      z: -0.2
    });
  }

  piano.appendChild(key);
  keyMap[n] = key;
}

piano.object3D.position.x = -(whiteIndex * WHITE_WIDTH)/2;

// ---------- RECORD BUTTON ----------
recordBtn.addEventListener("click", () => {
  window.midiState.recording = !window.midiState.recording;
  recordBtn.setAttribute("color",
    window.midiState.recording ? "#ff0000" : "#880000"
  );

  if (window.midiState.recording) {
    window.midiState.recorded = [];
    recordStart = performance.now();
  }
});

// ---------- PLAY BUTTON ----------
playBtn.addEventListener("click", () => {
  if (!window.midiState.recorded.length) return;

  window.midiState.playing = true;
  playbackStart = performance.now();

  trebleLane.innerHTML = "";
  bassLane.innerHTML = "";
});

// ---------- MIDI ----------
navigator.requestMIDIAccess?.().then(access => {
  access.inputs.forEach(input => {
    input.onmidimessage = handleMIDI;
  });
});

function handleMIDI(event) {
  const [status, note, velocity] = event.data;
  const type = status & 0xf0;

  if (type === 0x90 && velocity > 0) noteOn(note, velocity);
  if (type === 0x80 || (type === 0x90 && velocity === 0)) noteOff(note);
}

function noteOn(note, velocity) {

  keyMap[note]?.setAttribute("color", "#ff4444");

  window.midiState.activeNotes[note] = {
    start: performance.now()
  };

  if (window.midiState.recording) {
    window.midiState.activeNotes[note].recordStart =
      (performance.now() - recordStart)/1000;
  }
}

function noteOff(note) {

  const isBlack = [1,3,6,8,10].includes(note % 12);
  keyMap[note]?.setAttribute("color", isBlack ? "#000" : "#fff");

  if (!window.midiState.activeNotes[note]) return;

  if (window.midiState.recording) {
    const duration =
      (performance.now() - window.midiState.activeNotes[note].start)/1000;

    window.midiState.recorded.push({
      note,
      start: window.midiState.activeNotes[note].recordStart,
      duration
    });
  }

  delete window.midiState.activeNotes[note];
}

// ---------- PLAYBACK LOOP ----------
scene.addEventListener("tick", () => {

  if (!window.midiState.playing) return;

  const elapsed = (performance.now() - playbackStart)/1000;

  window.midiState.recorded.forEach(n => {
    if (!n.spawned && elapsed >= n.start) {
      spawnNote(n);
      n.spawned = true;
    }
  });

  trebleLane.object3D.position.y -= SCROLL_SPEED;
  bassLane.object3D.position.y -= SCROLL_SPEED;

  const totalLength =
    Math.max(...window.midiState.recorded.map(n => n.start+n.duration));

  if (elapsed > totalLength) {
    window.midiState.playing = false;
    window.midiState.recorded.forEach(n => n.spawned = false);
  }
});

function spawnNote(n) {

  const lane = n.note >= MIDDLE_C ? trebleLane : bassLane;

  const box = document.createElement("a-box");
  box.setAttribute("width", 0.12);
  box.setAttribute("height", n.duration * 2);
  box.setAttribute("depth", 0.1);
  box.setAttribute("color",
    n.note >= MIDDLE_C ? "#00ffff" : "#ff00ff"
  );

  box.setAttribute("position", {
    x: (n.note - MIDDLE_C)*0.12,
    y: 0,
    z: 0
  });

  lane.appendChild(box);
}

});
</script>

</body>
</html>
