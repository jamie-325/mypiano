<!DOCTYPE html>
<html>
<head>
    <title>Quest VR Piano - MR Fix</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://surikov.github.io/webaudiofont/npm/dist/WebAudioFontPlayer.js"></script>
    <script src="https://surikov.github.io/webaudiofontdata/sound/0000_Aspirin_sf2_file.js"></script>
</head>
<body>

    <a-scene quest-passthrough renderer="alpha: true; colorManagement: true;">
        
        <a-entity id="piano-wrapper" position="0 1.2 -0.5">
            <a-entity id="piano-keys"></a-entity>
        </a-entity>

        <a-entity id="ui-panel" position="0 1.5 -0.6">
            <a-plane color="#111" width="0.9" height="0.6" opacity="0.9" rotation="-10 0 0">
                <a-text id="status-text" value="1. Click START\n2. Use 'A' to Position\n3. Click 'TOGGLE MR'" 
                        align="center" position="0 0.18 0.01" width="0.7"></a-text>
                
                <a-circle id="start-btn" class="raycastable" position="-0.25 -0.1 0.02" radius="0.08" color="#4CAF50">
                    <a-text value="START" align="center" width="0.8" position="0 0 0.01"></a-text>
                </a-circle>

                <a-circle id="mr-btn" class="raycastable" position="0.25 -0.1 0.02" radius="0.08" color="#9C27B0">
                    <a-text value="TOGGLE MR" align="center" width="0.8" position="0 0 0.01"></a-text>
                </a-circle>

                <a-circle id="lock-btn" class="raycastable" position="0 -0.1 0.02" radius="0.08" color="#2196F3" visible="false">
                    <a-text value="LOCK" align="center" width="0.8" position="0 0 0.01"></a-text>
                </a-circle>
            </a-plane>
        </a-entity>

        <a-entity id="leftHand" laser-controls="hand: left" raycaster="objects: .raycastable; far: 5"></a-entity>
        <a-entity id="rightHand" laser-controls="hand: right" raycaster="objects: .raycastable; far: 5"></a-entity>

        <a-camera position="0 1.6 0"></a-camera>
        <a-sky id="sky" color="#222"></a-sky>
    </a-scene>

    <script>
        // --- QUEST PASSTHROUGH COMPONENT ---
        AFRAME.registerComponent('quest-passthrough', {
            init: function () {
                this.el.addEventListener('enter-vr', () => {
                    if (this.el.is('ar-mode')) {
                        // In AR mode (standard), clear colors automatically
                        document.getElementById('sky').setAttribute('visible', 'false');
                    }
                });
            },
            toggleMR: function(active) {
                const sky = document.getElementById('sky');
                if (active) {
                    // Set the background to be fully transparent for the Quest
                    this.el.setAttribute('background', 'transparent: true');
                    sky.setAttribute('visible', 'false');
                    // This is the "magic" line for the Quest Browser
                    this.el.renderer.setClearColor(0x000000, 0);
                } else {
                    this.el.setAttribute('background', 'transparent: false');
                    sky.setAttribute('visible', 'true');
                    this.el.renderer.setClearColor(0x222222, 1);
                }
            }
        });

        // --- PIANO & AUDIO LOGIC ---
        let audioCtx = null;
        let player = new WebAudioFontPlayer();
        let pianoInstrument = _tone_0000_Aspirin_sf2_file;
        let isGrabbing = false, isLocked = false, mrActive = false;

        const wrapper = document.getElementById('piano-wrapper');
        const statusText = document.getElementById('status-text');
        const rightHand = document.getElementById('rightHand');

        // Toggle MR Button
        document.getElementById('mr-btn').addEventListener('click', () => {
            mrActive = !mrActive;
            document.querySelector('a-scene').components['quest-passthrough'].toggleMR(mrActive);
            statusText.setAttribute('value', mrActive ? "MR ACTIVE\nLook around your room!" : "VR ACTIVE");
        });

        // Start Audio
        document.getElementById('start-btn').addEventListener('click', () => {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                player.loader.decodeAfterLoading(audioCtx, '_tone_0000_Aspirin_sf2_file');
                document.getElementById('start-btn').setAttribute('visible', 'false');
                document.getElementById('lock-btn').setAttribute('visible', 'true');
                statusText.setAttribute('value', "SOUND ON\nHold 'A' to position piano.");
            }
        });

        // Lock Piano
        document.getElementById('lock-btn').addEventListener('click', () => {
            isLocked = true;
            document.getElementById('lock-btn').setAttribute('visible', 'false');
            statusText.setAttribute('value', "POSITION LOCKED");
        });

        // Grab with A-button
        rightHand.addEventListener('abuttondown', () => { if (!isLocked) isGrabbing = true; });
        rightHand.addEventListener('abuttonup', () => { isGrabbing = false; });

        AFRAME.registerComponent('piano-mover', {
            tick: function () {
                if (isGrabbing && !isLocked) {
                    let pos = new THREE.Vector3();
                    let quat = new THREE.Quaternion();
                    rightHand.object3D.getWorldPosition(pos);
                    rightHand.object3D.getWorldQuaternion(quat);
                    wrapper.object3D.position.copy(pos);
                    wrapper.object3D.quaternion.copy(quat);
                }
            }
        });
        document.querySelector('a-scene').setAttribute('piano-mover', '');

        // Generate Piano Keys
        function initPiano() {
            const container = document.querySelector('#piano-keys');
            const totalWidth = 1.22, whiteKeyCount = 52, keyWidth = totalWidth / whiteKeyCount;
            const blackKeyPattern = [1, 1, 0, 1, 1, 1, 0];
            let currentMidi = 21; 

            for (let i = 0; i < whiteKeyCount; i++) {
                addKey(container, (i * keyWidth) - (totalWidth/2), 0, 0, keyWidth * 0.9, 0.03, 0.25, 'white', currentMidi);
                let note = currentMidi % 12;
                currentMidi += ([4, 11].includes(note)) ? 1 : 2;
            }
            currentMidi = 22;
            for (let i = 0; i < 51; i++) {
                let octavePos = (i + 5) % 7;
                if (blackKeyPattern[octavePos] === 1) {
                    addKey(container, ((i + 0.5) * keyWidth) - (totalWidth/2), 0.02, -0.08, keyWidth * 0.6, 0.05, 0.15, 'black', currentMidi);
                }
                let note = currentMidi % 12;
                currentMidi += ([1, 3, 6, 8, 10].includes(note)) ? 2 : 1;
            }
        }

        function addKey(parent, x, y, z, w, h, d, color, midi) {
            let key = document.createElement('a-box');
            key.setAttribute('class', 'raycastable');
            key.setAttribute('position', `${x} ${y} ${z}`);
            key.setAttribute('width', w); key.setAttribute('height', h); key.setAttribute('depth', d);
            key.setAttribute('color', color);
            key.setAttribute('opacity', 0.8);
            key.setAttribute('piano-key', `midi: ${midi}; orig: ${color}`);
            parent.appendChild(key);
        }

        AFRAME.registerComponent('piano-key', {
            schema: { midi: {type: 'int'}, orig: {type: 'string'} },
            init: function () {
                this.el.addEventListener('mousedown', () => {
                    if (audioCtx && isLocked) {
                        player.queueWaveTable(audioCtx, audioCtx.destination, pianoInstrument, audioCtx.currentTime, this.data.midi, 1.0);
                        this.el.setAttribute('color', 'yellow');
                        setTimeout(() => this.el.setAttribute('color', this.data.orig), 150);
                    }
                });
            }
        });

        window.onload = initPiano;
    </script>
</body>
</html>
