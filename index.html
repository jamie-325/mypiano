<!DOCTYPE html>
<html>
<head>
    <title>Quest VR Piano - Grab & Place</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://surikov.github.io/webaudiofont/npm/dist/WebAudioFontPlayer.js"></script>
    <script src="https://surikov.github.io/webaudiofontdata/sound/0000_Aspirin_sf2_file.js"></script>
</head>
<body>

    <a-scene renderer="colorManagement: true;">
        
        <a-entity id="piano-wrapper" position="0 1 -0.5">
            <a-entity id="piano-keys"></a-entity>

            <a-box id="handle" class="raycastable" 
                   position="0 0.1 0" width="0.2" height="0.1" depth="0.1" 
                   color="#FF9800" visible="true">
                <a-text value="GRAB HERE" align="center" position="0 0.08 0" scale="0.5"></a-text>
            </a-box>
        </a-entity>

        <a-entity id="ui-panel" position="0 1.6 -0.8">
            <a-plane color="#222" width="0.8" height="0.4" opacity="0.9">
                <a-text id="status-text" value="1. Click START to Enable Sound\n2. Grab Orange Box to move Piano" 
                        align="center" position="0 0.1 0.01" width="0.7"></a-text>
                
                <a-box id="start-btn" class="raycastable" position="0 -0.1 0.02" width="0.3" height="0.1" color="#4CAF50">
                    <a-text value="START" align="center" width="0.8" position="0 0 0.02"></a-text>
                </a-box>

                <a-box id="lock-btn" class="raycastable" position="0 -0.1 0.02" width="0.3" height="0.1" color="#2196F3" visible="false">
                    <a-text value="LOCK PIANO" align="center" width="0.8" position="0 0 0.02"></a-text>
                </a-box>
            </a-plane>
        </a-entity>

        <a-entity id="leftHand" laser-controls="hand: left" raycaster="objects: .raycastable; far: 10"></a-entity>
        <a-entity id="rightHand" laser-controls="hand: right" raycaster="objects: .raycastable; far: 10"></a-entity>

        <a-camera position="0 1.6 0"></a-camera>
    </a-scene>

    <script>
        let audioCtx = null;
        let player = new WebAudioFontPlayer();
        let pianoInstrument = _tone_0000_Aspirin_sf2_file;
        
        let isGrabbing = false;
        let activeController = null;

        const wrapper = document.getElementById('piano-wrapper');
        const handle = document.getElementById('handle');
        const startBtn = document.getElementById('start-btn');
        const lockBtn = document.getElementById('lock-btn');
        const statusText = document.getElementById('status-text');

        // 1. GENERATE PIANO IMMEDIATELY (Standard 88 keys, ~1.23 meters wide)
        function initPiano() {
            const container = document.querySelector('#piano-keys');
            const totalWidth = 1.22; // Standard 88-key piano width
            const whiteKeyCount = 52;
            const keyWidth = totalWidth / whiteKeyCount;
            const blackKeyPattern = [1, 1, 0, 1, 1, 1, 0];
            let currentMidi = 21; 

            for (let i = 0; i < whiteKeyCount; i++) {
                addKey(container, (i * keyWidth) - (totalWidth/2), 0, 0, keyWidth * 0.9, 0.03, 0.2, 'white', currentMidi);
                let note = currentMidi % 12;
                currentMidi += ([4, 11].includes(note)) ? 1 : 2;
            }

            currentMidi = 22;
            for (let i = 0; i < 51; i++) {
                let octavePos = (i + 5) % 7;
                if (blackKeyPattern[octavePos] === 1) {
                    addKey(container, ((i + 0.5) * keyWidth) - (totalWidth/2), 0.02, -0.06, keyWidth * 0.6, 0.05, 0.12, 'black', currentMidi);
                }
                let note = currentMidi % 12;
                currentMidi += ([1, 3, 6, 8, 10].includes(note)) ? 2 : 1;
            }
        }

        function addKey(parent, x, y, z, w, h, d, color, midi) {
            let key = document.createElement('a-box');
            key.setAttribute('class', 'raycastable');
            key.setAttribute('position', `${x} ${y} ${z}`);
            key.setAttribute('width', w); key.setAttribute('height', h); key.setAttribute('depth', d);
            key.setAttribute('color', color);
            key.setAttribute('piano-key', `midi: ${midi}; orig: ${color}`);
            parent.appendChild(key);
        }

        // 2. AUDIO & UI LOGIC
        startBtn.addEventListener('click', () => {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                player.loader.decodeAfterLoading(audioCtx, '_tone_0000_Aspirin_sf2_file');
                startBtn.setAttribute('visible', 'false');
                lockBtn.setAttribute('visible', 'true');
                statusText.setAttribute('value', "GRAB ORANGE BOX\nAlign with real piano\nThen click LOCK");
            }
        });

        lockBtn.addEventListener('click', () => {
            handle.setAttribute('visible', 'false');
            handle.setAttribute('class', 'not-raycastable'); // Disable grabbing
            statusText.setAttribute('value', "PIANO LOCKED\nReady to play!");
            lockBtn.setAttribute('visible', 'false');
            // Show a reset button if needed
            setTimeout(() => { document.getElementById('ui-panel').setAttribute('visible', 'false'); }, 2000);
        });

        // 3. GRAB LOGIC (Move piano with controller)
        handle.addEventListener('mousedown', (evt) => {
            isGrabbing = true;
            activeController = evt.detail.cursorEl; 
        });

        window.addEventListener('triggerup', () => {
            isGrabbing = false;
            activeController = null;
        });

        // Frame-by-frame update to stick piano to controller
        AFRAME.registerComponent('piano-mover', {
            tick: function () {
                if (isGrabbing && activeController) {
                    // Match the wrapper position/rotation to the controller
                    let controllerPos = new THREE.Vector3();
                    activeController.object3D.getWorldPosition(controllerPos);
                    
                    let controllerRot = new THREE.Vector3();
                    activeController.object3D.getWorldQuaternion(wrapper.object3D.quaternion);
                    
                    wrapper.object3D.position.copy(controllerPos);
                }
            }
        });
        document.querySelector('a-scene').setAttribute('piano-mover', '');

        // 4. KEY COMPONENT
        AFRAME.registerComponent('piano-key', {
            schema: { midi: {type: 'int'}, orig: {type: 'string'} },
            init: function () {
                this.el.addEventListener('mousedown', (evt) => {
                    // Don't play sound if we are trying to grab the handle
                    if (isGrabbing || evt.target.id === "handle") return;
                    if (audioCtx) {
                        player.queueWaveTable(audioCtx, audioCtx.destination, pianoInstrument, audioCtx.currentTime, this.data.midi, 1.0);
                        this.el.setAttribute('color', 'yellow');
                        setTimeout(() => this.el.setAttribute('color', this.data.orig), 150);
                    }
                });
            }
        });

        window.onload = initPiano;
    </script>
</body>
</html>
